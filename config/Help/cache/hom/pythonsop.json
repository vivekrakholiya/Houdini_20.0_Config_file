{"type": "root", "attrs": {}, "body": [{"level": 0, "type": "title", "indent": 0, "text": ["Define a geometry node (SOP) using Python"], "extent": [0, 46]}, {"level": 2, "id": null, "container": true, "type": "h", "indent": 0, "text": ["Overview"], "extent": [46, 62], "body": [{"type": "bullet_group", "body": [{"blevel": 2, "type": "bullet", "indent": 0, "text": ["If you want to define a new, reusable geometry node using Python, see ", {"type": "q", "text": ["creating a new node type"]}, " below."], "extent": [62, 170]}, {"blevel": 2, "type": "bullet", "indent": 0, "text": ["If you just want to script a one-off change, you can use the ", {"scheme": "Node", "value": "/nodes/sop/python", "type": "link", "text": ["Python SOP"], "fullpath": "/nodes/sop/python.html"}, " to run a Python snippet on geometry without having to create a new node type."], "extent": [170, 341]}], "container": true}, {"type": "note_group", "body": [{"type": "note", "indent": 0, "role": "item", "extent": [341, 347], "body": [{"type": "para", "indent": 4, "text": ["Do not set node parameters inside a Python SOP.  This creates\n    broken dependencies and causes many issues."], "extent": [347, 462]}], "container": true}], "container": true, "role": "item_group"}]}, {"level": 2, "id": "node_type", "container": true, "type": "h", "indent": 0, "text": ["Creating a new node type"], "extent": [462, 505], "body": [{"type": "ord_group", "body": [{"blevel": 2, "type": "ord", "indent": 0, "text": ["Choose ", {"type": "ui", "text": ["File \u25b8 New Asset"]}, "."], "extent": [505, 538]}, {"blevel": 2, "type": "ord", "indent": 0, "text": ["Set the ", {"type": "ui", "text": ["Operator Definition"]}, " to ", {"type": "code", "text": ["python"]}, ", then set ", {"type": "ui", "text": ["Network type"]}, " to ", {"type": "ui", "text": ["Geometry"]}, "."], "extent": [538, 629]}, {"blevel": 2, "type": "ord", "indent": 0, "text": ["Use the ", {"type": "ui", "text": ["Save to library"]}, " option to set an OTL library file to save the new node type into."], "extent": [629, 726]}, {"blevel": 2, "type": "ord", "indent": 0, "text": ["Click ", {"type": "ui", "text": ["Accept"]}, "."], "extent": [726, 747], "body": [{"type": "para", "indent": 4, "text": ["The ", {"scheme": null, "value": "/ref/windows/optype", "type": "link", "text": ["type properties window"], "fullpath": "/ref/windows/optype.html"}, " appears."], "extent": [747, 814]}], "container": true}, {"blevel": 2, "type": "ord", "indent": 0, "text": ["Use the ", {"scheme": null, "value": "/ref/windows/optype", "type": "link", "text": ["options in the type properties window"], "fullpath": "/ref/windows/optype.html"}, " to define the interface for your new node type."], "extent": [814, 933]}, {"blevel": 2, "type": "ord", "indent": 0, "text": ["Click the ", {"type": "ui", "text": ["Code"]}, " tab to view and edit the Python script that defines the SOP\u2019s behavior."], "extent": [933, 1027]}], "container": true}, {"type": "tip_group", "body": [{"type": "tip", "indent": 0, "role": "item", "extent": [1027, 1032], "body": [{"type": "para", "indent": 4, "text": ["If you need to edit the script after closing the type properties window, right-click an instance of the node and choose ", {"type": "ui", "text": ["Type properties"]}, "."], "extent": [1032, 1178]}], "container": true}], "container": true, "role": "item_group"}]}, {"level": 2, "id": null, "container": true, "type": "h", "indent": 0, "text": ["Writing the code"], "extent": [1178, 1201], "body": [{"type": "para", "indent": 0, "text": ["To get the node\u2019s incoming geometry, use"], "extent": [1201, 1244]}, {"lang": "python", "type": "pre", "indent": 0, "text": ["\ngeo = hou.pwd().geometry()\n"], "extent": [1244, 1288]}, {"type": "para", "indent": 0, "text": ["The ", {"type": "code", "text": ["hou.pwd()"]}, " function returns the currently cooking ", {"scheme": "Hom", "value": "/hom/hou/SopNode", "type": "link", "text": ["Node"], "fullpath": "/hom/hou/SopNode.html"}, ", and the ", {"type": "code", "text": ["geometry()"]}, " method returns a ", {"scheme": "Hom", "value": "/hom/hou/Geometry", "type": "link", "text": "", "fallback_text": "hou.Geometry", "fullpath": "/hom/hou/Geometry.html"}, " object.  If an input SOP\nis connected to the first input of the Python SOP, Houdini copies the input\nSOP\u2019s geometry into the Python SOP\u2019s geometry before running the Python code."], "extent": [1288, 1605]}, {"type": "tip_group", "body": [{"type": "tip", "indent": 0, "role": "item", "extent": [1605, 1610], "body": [{"type": "para", "indent": 4, "text": ["To get the geometry from an input other than the first, use the ", {"type": "code", "text": ["inputs()"]}, " method of ", {"scheme": "Hom", "value": "/hom/hou/SopNode", "type": "link", "text": ["Node"], "fullpath": "/hom/hou/SopNode.html"}, " to get the input nodes, and then the ", {"type": "code", "text": ["geometry()"]}, " method of one of those nodes to get its geometry."], "extent": [1610, 1827]}, {"lang": "python", "type": "pre", "indent": 4, "text": ["\n    this_node = hou.pwd()\n    inputs = this_node.inputs()\n\n    # Get the geometry from the second input\n    # (first input=0, second input=1, third=2, etc.)\n    second_input_geo = inputs[1].geometry()\n    "], "extent": [1827, 2057]}], "container": true}], "container": true, "role": "item_group"}, {"type": "para", "indent": 0, "text": ["You can then call methods on the geometry object (", {"type": "code", "text": ["geo"]}, " in this example) to modify the outgoing geometry. See the documentation for the ", {"scheme": "Hom", "value": "/hom/hou/Geometry", "type": "link", "text": "", "fallback_text": "hou.Geometry", "fullpath": "/hom/hou/Geometry.html"}, " object for how to manipulate the geometry."], "extent": [2057, 2257]}, {"type": "para", "indent": 0, "text": ["For example, to add a polygon to the geometry:"], "extent": [2257, 2305]}, {"lang": "python", "type": "pre", "indent": 0, "text": ["\npoly = geo.createPolygon()\nfor position in (0,0,0), (1,0,0), (0,1,0):\n    point = geo.createPoint()\n    point.setPosition(position)\n    poly.addVertex(point)\n"], "extent": [2305, 2480]}, {"type": "para", "indent": 0, "text": ["If you want to create a ", {"type": "q", "text": ["source"]}, " node rather than a ", {"type": "q", "text": ["filter"]}, " node, simply set the node\u2019s number of inputs to 0 in the type properties. Calling ", {"type": "code", "text": ["hou.pwd().geometry()"]}, " will return an empty geometry you can add to."], "extent": [2480, 2694]}]}, {"level": 2, "id": "making_interruptable", "container": true, "type": "h", "indent": 0, "text": ["Making the SOP interruptible"], "extent": [2694, 2752], "body": [{"type": "para", "indent": 0, "text": ["If the node takes a long time to cook when given large input\ngeometry, you may want to be able to interrupt its cooking by pressing Escape.\nTo make your SOP interruptible, periodically call\n", {"scheme": "Hom", "value": "/hom/hou/updateProgressAndCheckForInterrupt", "type": "link", "text": "", "fallback_text": "hou.updateProgressAndCheckForInterrupt", "fullpath": "/hom/hou/updateProgressAndCheckForInterrupt.html"}, ".  For example, you can press\nEscape to stop this SOP from cooking further:"], "extent": [2752, 3064]}, {"lang": "python", "type": "pre", "indent": 0, "text": ["\ngeo = hou.pwd().geometry()\n\n# Evaluate the \"t\" parameter to see how much to translate each point.\ntranslation = hou.Vector3(hou.parmTuple(\"t\").eval())\n\nfor point in geo.points():\n    # Set the new position for each point.\n    point.setPosition(point.position() + translation)\n\n    # Check if the user pressed Escape.\n    if hou.updateProgressAndCheckForInterrupt():\n        break\n"], "extent": [3064, 3461]}]}, {"level": 2, "id": "errors_and_warnings", "container": true, "type": "h", "indent": 0, "text": ["SOP Errors and Warnings"], "extent": [3461, 3514], "body": [{"type": "para", "indent": 0, "text": ["If your Python surface node generates an exception, the node will turn red\nwith an error and you can view the stack trace of the error by middle-clicking\non it."], "extent": [3514, 3677]}, {"type": "para", "indent": 0, "text": ["If you would like to generate an error message to the user that doesn\u2019t contain\na Python stack trace, raise a ", {"scheme": "Hom", "value": "/hom/hou/NodeError", "type": "link", "text": "", "fallback_text": "hou.NodeError", "fullpath": "/hom/hou/NodeError.html"}, " exception.  For example,\nrunning"], "extent": [3677, 3841]}, {"lang": "python", "type": "pre", "indent": 0, "text": ["\nraise hou.NodeError(\"Invalid parameter settings\")\n"], "extent": [3841, 3908]}, {"type": "para", "indent": 0, "text": ["will turn the node red with an error message of ", {"type": "code", "text": ["\"Invalid parameter settings\""]}, ".\nSimilarly, you can add node warnings by raising instances of\n", {"scheme": "Hom", "value": "/hom/hou/NodeWarning", "type": "link", "text": "", "fallback_text": "hou.NodeWarning", "fullpath": "/hom/hou/NodeWarning.html"}, "."], "extent": [3908, 4074]}]}, {"level": 2, "id": "local_variables", "container": true, "type": "h", "indent": 0, "text": ["Creating local variables for new attributes"], "extent": [4074, 4142], "body": [{"type": "para", "indent": 0, "text": [{"scheme": "Hom", "value": "/hom/hou/Geometry#addAttrib", "type": "link", "text": "", "fallback_text": "hou.Geometry.addAttrib", "fullpath": "/hom/hou/Geometry.html#addAttrib", "fragment": "#addAttrib"}, " contains a parameter to control whether Houdini\ncreates a local variable for newly added attributes.  There is no need to\nmodify the varmap attribute directly."], "extent": [4142, 4333]}]}, {"level": 2, "id": "profiling", "container": true, "type": "h", "indent": 0, "text": ["Profiling the SOP code"], "extent": [4333, 4374], "body": [{"type": "para", "indent": 0, "text": ["You can profile your Python surface node with Python\u2019s ", {"type": "code", "text": ["cProfile"]}, " module."], "extent": [4374, 4450]}, {"type": "tip_group", "body": [{"type": "tip", "indent": 0, "role": "item", "extent": [4450, 4455], "body": [{"type": "para", "indent": 4, "text": ["If you are on Ubuntu, use ", {"type": "code", "text": ["aptitude"]}, " to install ", {"type": "code", "text": ["python-profiler"]}, " since the standard library is missing pstats in Ubuntu."], "extent": [4455, 4586]}], "container": true}], "container": true, "role": "item_group"}, {"type": "para", "indent": 0, "text": ["You should write your surface node\u2019s script so the work is done inside a function, instead of a bunch of statements at the top level, for example:"], "extent": [4586, 4734]}, {"lang": "python", "type": "pre", "indent": 0, "text": ["\ndef cook():\n    poly = geo.createPolygon()\n    for position in (0,0,0), (1,0,0), (0,1,0):\n        point = geo.createPoint()\n        point.setPosition(position)\n        poly.addVertex(point)\n        \ncook()\n"], "extent": [4734, 4957]}, {"type": "para", "indent": 0, "text": ["Import ", {"type": "code", "text": ["cProfile"]}, " and use ", {"type": "code", "text": ["cProfile.runctx"]}, " to call your function instead of calling it directly:"], "extent": [4957, 5057]}, {"lang": "python", "type": "pre", "indent": 0, "text": ["\ndef cook():\n    poly = geo.createPolygon()\n    for position in (0,0,0), (1,0,0), (0,1,0):\n        point = geo.createPoint()\n        point.setPosition(position)\n        poly.addVertex(point)\n        \ncProfile.runctx('cook()', globals(), locals())\n"], "extent": [5057, 5320]}, {"type": "para", "indent": 0, "text": ["This will print a summary of your script\u2019s run time to the Python shell when the node cooks."], "extent": [5320, 5415]}]}, {"level": 2, "id": null, "container": true, "type": "h", "indent": 0, "text": ["Writing Part of the SOP in C++"], "extent": [5415, 5452], "body": [{"type": "para", "indent": 0, "text": ["See ", {"scheme": null, "value": "extendingwithcpp", "type": "link", "text": ["Extending HOM with C++"], "fullpath": "/hom/extendingwithcpp.html"}, " to see how to easily write a\nportion of your SOP in C++."], "extent": [5452, 5557]}]}, {"level": 2, "id": "external_source", "container": true, "type": "h", "indent": 0, "text": ["Storing your Code Outside a Digital Asset"], "extent": [5557, 5623], "body": [{"type": "para", "indent": 0, "text": ["You may want to store your source code outside of your digital asset in\norder to manage it under a version control system.  It is possible to use\nthe Type Properties dialog to set up your asset\u2019s parameters and then inject\nthe Python source code into the ", {"type": "code", "text": ["otl"]}, " file."], "extent": [5623, 5892]}, {"type": "para", "indent": 0, "text": ["You can use the following function to update your digital asset to use the\nPython source code from a file:"], "extent": [5892, 5999]}, {"lang": "python", "type": "pre", "indent": 0, "text": ["\ndef loadPythonSourceIntoAsset(otl_file_path, node_type_name, source_file_path):\n    # Load the Python source code.\n    source_file = open(source_file_path, \"rb\")\n    source = source_file.read()\n    source_file.close()\n\n    # Find the asset definition in the otl file.\n    definitions = [definition\n        for definition in hou.hda.definitionsInFile(otl_file_path)\n        if definition.nodeTypeName() == node_type_name]\n    assert(len(definitions) == 1)\n    definition = definitions[0]\n\n    # Store the source code into the PythonCook section of the asset.\n    definition.addSection(\"PythonCook\", source)\n"], "extent": [5999, 6622]}, {"type": "para", "indent": 0, "text": ["TODO: Document how to use geo.globPoints(), geo.globPrims(), etc. to implement"], "extent": [6622, 6702], "body": [{"type": "para", "indent": 6, "text": ["filters."], "extent": [6702, 6717]}], "container": true}]}], "title": ["Define a geometry node (SOP) using Python"]}